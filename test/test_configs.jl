using CoilForces
using Test

@testset "Test coils from known stellarator configurations" begin
    @testset "For HSX coils, compare the curvature and torsion to reference value from simsopt" begin
        # Reference data for this test was generated by
        # 20221223-02-HSX_coils_julia_simsopt_benchmark
        κ_python = [[ 7.788390617520463  7.816618974072718  6.690896736135938  4.702662304298967  3.46008855229832   4.133575382390299]
                [ 7.786703789259652  4.506484257386549  7.056258337803115  7.6710549240336    8.40080225348436   8.884894572683653]
                [ 1.547117439970494  8.572530738803804 10.717813809724882  4.013722051692056  4.669567578004     8.92524552152488 ]
                [ 1.63275255086447   1.518489387297199  0.670776451118648  9.907336818867176 10.261376385832044 11.540375483349568]
                [ 1.639008337314427  1.125501213679983  0.755777748574065  1.79843017520384   3.020020822382539  2.325582030740719]
                [ 1.402433668915285  0.764819631415868  1.15054415636549   2.529581433203301  5.281370852248262  2.657156220664195]
                [ 7.468518763417453  6.174970098901197  4.720580548840681  5.077289147604544  2.655835976297646  5.222540888727932]
                [ 6.535269964233732  7.323049711807227 10.659684557948768  3.651924372092441  5.935989650662675  6.363548323997983]
                [ 4.082050991465111  7.453115153441385 11.467110937595434 10.432377192978498  6.98038808236203   4.528002419956208]
                [ 3.993422698348994  2.4209396317436    3.020018685310059 10.59817163512972   9.696136702701665  6.140358237166969]
                [ 3.65925740026044   6.605049304619721  2.915812902932794  3.737066031654033  3.592707128958983  4.129365837237263]
                [ 1.801272752262573  3.694775386269375  3.322152268822685  1.855746131219399  2.01095132335426   0.611871613014779]
                [ 1.463329202515512  1.097172311018267  0.617555036646229  9.214730236741016  2.554664024970669  9.199214778704576]
                [ 2.101558159565957  2.284350143507806  2.199889271104092  4.577529653905849 10.159495936159576 10.276207515578328]
                [ 4.127568517332473  5.398513162504659  5.887166450941546  1.581872254965836  9.220997726464056 11.25186379572569 ]
                [ 2.079939575696845  2.891834328422985  3.53632191821778   6.227872501694971  4.121450780388801  4.429623060968289]]

        τ_python = [[  9.488755975021485   6.252124364392375   6.269124137644585   9.438875934504374  17.972501134398897  20.842405937565655]
                [ -4.044049044248785 -13.308916029550948  -5.059376857691287   2.653821843875178  -1.226779496578047  10.122019332818791]
                [-24.056078342227433   0.345135093711389   3.549123821472008 -49.62371371690056  -22.58248944911618  -14.128227632475527]
                [  3.665776546343154   8.074504083607609  34.39133047746027    3.124571010042663   4.050158530966767   1.46522419474183 ]
                [ 12.50392478257957    0.611458098879542  -9.179821306715908 -15.258186432672241 -21.68871284798456  -41.83465386726194 ]
                [  3.806467107716567  -8.504333967573979 -14.151312546838566 -19.225569928038887 -19.689050728938618  -6.032010091086978]
                [ 16.087211515366427  11.188591557476634   0.469592807037034  -8.83667047761725  -13.058797539491316   1.464591741141592]
                [-20.634132660201605 -17.752366427679387   0.588477780017114  -5.269805032689205   0.358308037734105  -1.124545934795599]
                [  5.731441675580921   3.555848391131333  -6.925043921255386   7.48171156426298    6.556340826218933  -5.927866757022886]
                [  0.116367672912095  12.670112534184145   0.339654557093749  -5.242409209399544  -7.75680096065554    2.093095390184704]
                [ -5.482002109638236 -11.196632921393435  26.68544550214186    6.830404076834971   4.279396412263963  -1.081437204938237]
                [  3.660197878395389   6.225841444358591 -65.86273785315005   -0.970346840312703  13.248060735994805  -7.361848128987123]
                [  3.40142517300596   22.114984674817638   9.286063621165441  -4.834195131509975  27.931885749595693  -4.421407746170479]
                [ -2.404728672063177  -4.688098429259938  -4.328857806269522  -2.170823564383622  -4.912189530279823  -5.355295929380677]
                [  0.067430034364529  -1.100268140642378 -13.865115391584112  15.12783034281494    7.763441609726842  -2.175916665642481]
                [  4.904910924545839   7.060385093314725   4.022566158318275  -0.945330418883938   1.328980836324491   5.37491289106566 ]]

        nϕ = 16
        ϕ = (collect(1:nϕ) .- 1) * 2π / nϕ
        for jcoil in 1:6
            c = get_curve("hsx", jcoil)

            for j in 1:nϕ
                dℓdϕ, κ, τ, γ0, tangent, normal, binormal = Frenet_frame(c, ϕ[j])
                @test κ ≈ κ_python[j, jcoil]
                @test τ ≈ τ_python[j, jcoil]
            end
        end 
    end
end
